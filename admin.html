<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ç®¡ç†åå°</title>
    <style>
        *{margin:0;padding:0;box-sizing:border-box;font-family:PingFang SC,Helvetica Neue,sans-serif}
        :root{--bg:#fdf6fb;--card:#fff;--text:#444;--sub:#999;--main:#ff8fb7;--tag:#ffe0f0;--tagtext:#ff5a95}
        body{background:var(--bg);color:var(--text);padding-bottom:80px}
        .card{background:var(--card);border-radius:16px;padding:18px;margin-bottom:14px}
        .btn{width:100%;padding:12px;border:none;border-radius:12px;background:var(--main);color:#fff;font-weight:700;margin-top:8px}
        input,textarea,select{width:100%;padding:10px;margin:8px 0;border-radius:8px;border:1px solid #ddd}
        .title{color:var(--main);font-weight:700;margin-bottom:10px}
        img,video{max-width:100%;border-radius:8px;margin-top:8px}
        .del{background:#ff6b8b}
        #imgViewer{position:fixed;inset:0;background:#000000e6;display:none;place-items:center;color:#fff}
    </style>
</head>
<body>

<div class="card">
    <h3 class="title">âš™ï¸ ç®¡ç†åå°</h3>
    <input placeholder="æ˜µç§°" id="name">
    <input placeholder="èº«é«˜ cm" id="height">
    <input placeholder="ä½“é‡ kg" id="weight">
    <input placeholder="å°ºå¯¸" id="size">
    å°ºå¯¸å›¾ï¼š<input type="file" id="sizeImg" accept="image/*">
    <div id="sizeImgPreview" style="margin-top:8px;"></div>
    <button class="btn" onclick="saveProfile()">ä¿å­˜èµ„æ–™</button>
</div>

<div class="card">
    <h3 class="title">ğŸ“ å‘å¸ƒåŠ¨æ€</h3>
    <textarea placeholder="å†™ç‚¹ä»€ä¹ˆ..." id="postTxt" rows="3"></textarea>
    <input type="file" id="postFile" accept="image/*,video/*">
    <button class="btn" onclick="publish()">å‘å¸ƒ</button>
</div>

<div class="card">
    <h3 class="title">ğŸ”’ é™æ—¶ç§æˆ¿</h3>
    <input type="file" id="privateFile" accept="image/*,video/*">
    <select id="hour">
        <option value="3600000">1å°æ—¶</option>
        <option value="86400000">24å°æ—¶</option>
    </select>
    <button class="btn" onclick="addPrivate()">å‘å¸ƒç§æˆ¿</button>
</div>

<div class="card">
    <h3 class="title">ğŸ“Œ åŠ¨æ€ç®¡ç†</h3>
    <div id="list"></div>
</div>

<div id="imgViewer" onclick="closeViewer()">
    <img id="viewImg" style="max-width:90%;max-height:90vh">
</div>

<script>
// åˆå§‹åŒ– IndexedDB
let db;
const request = indexedDB.open('AdminDB', 1);

request.onupgradeneeded = function(event) {
    db = event.target.result;
    if (!db.objectStoreNames.contains('files')) {
        db.createObjectStore('files', { keyPath: 'id', autoIncrement: true });
    }
};

request.onsuccess = function(event) {
    db = event.target.result;
    loadProfile(); // é¡µé¢åŠ è½½æ—¶å…ˆå›å¡«èµ„æ–™
    show();         // å†æ˜¾ç¤ºåŠ¨æ€åˆ—è¡¨
};

request.onerror = function(event) {
    console.error('IndexedDB æ‰“å¼€å¤±è´¥:', event.target.errorCode);
};

// é¡µé¢åŠ è½½æ—¶è‡ªåŠ¨å›å¡«ç”¨æˆ·èµ„æ–™
function loadProfile() {
    const userStr = localStorage.user;
    if (!userStr) return;

    try {
        const user = JSON.parse(userStr);
        document.getElementById('name').value = user.name || '';
        document.getElementById('height').value = user.height || '';
        document.getElementById('weight').value = user.weight || '';
        document.getElementById('size').value = user.size || '';

        // å¦‚æœæœ‰å°ºå¯¸å›¾IDï¼Œå°è¯•åŠ è½½é¢„è§ˆ
        if (user.sizeImg) {
            getFileFromDB(user.sizeImg).then(url => {
                document.getElementById('sizeImgPreview').innerHTML =
                    `<img src="${url}" style="max-width:200px;max-height:200px;">`;
            }).catch(e => {
                console.error('åŠ è½½å°ºå¯¸å›¾å¤±è´¥:', e);
                document.getElementById('sizeImgPreview').innerHTML = '<p>å°ºå¯¸å›¾åŠ è½½å¤±è´¥</p>';
            });
        }
    } catch (e) {
        console.error('è§£æç”¨æˆ·èµ„æ–™å¤±è´¥:', e);
    }
}

// ä¿å­˜èµ„æ–™
async function saveProfile() {
    let user = {
        name: document.getElementById('name').value,
        height: document.getElementById('height').value,
        weight: document.getElementById('weight').value,
        size: document.getElementById('size').value,
        avatar: 'https://picsum.photos/200',
        style: ['å¯çˆ±', 'å¾¡å§'],
        sizeImg: null
    };

    let f = document.getElementById('sizeImg').files[0];
    if (f) {
        try {
            const fileId = await saveFileToDB(f);
            user.sizeImg = fileId;
        } catch (e) {
            alert('ä¿å­˜å›¾ç‰‡å¤±è´¥: ' + e.message);
            return;
        }
    } else {
        // å¦‚æœæ²¡æœ‰é€‰æ‹©æ–°å›¾ç‰‡ï¼Œä¿ç•™åŸæœ‰çš„sizeImg
        const oldUser = JSON.parse(localStorage.user || '{}');
        user.sizeImg = oldUser.sizeImg || null;
    }

    localStorage.user = JSON.stringify(user);
    alert('ä¿å­˜æˆåŠŸ');
    loadProfile(); // ä¿å­˜åé‡æ–°åŠ è½½èµ„æ–™æ˜¾ç¤º
}

// å‘å¸ƒåŠ¨æ€
async function publish() {
    let t = document.getElementById('postTxt').value;
    let f = document.getElementById('postFile').files[0];

    if (!t && !f) {
        alert('è¯·è¾“å…¥å†…å®¹æˆ–é€‰æ‹©æ–‡ä»¶');
        return;
    }

    let p = { txt: t, type: '', fileId: null, time: Date.now() };

    if (f) {
        try {
            const fileId = await saveFileToDB(f);
            p.type = f.type.startsWith('image') ? 'img' : 'vid';
            p.fileId = fileId;
        } catch (e) {
            alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ' + e.message);
            return;
        }
    }

    let a = JSON.parse(localStorage.posts || '[]');
    a.unshift(p);
    localStorage.posts = JSON.stringify(a);
    alert('å‘å¸ƒæˆåŠŸ');
    show();
}

// å‘å¸ƒç§æˆ¿
async function addPrivate() {
    let f = document.getElementById('privateFile').files[0];
    let h = document.getElementById('hour').value;

    if (!f) {
        alert('è¯·é€‰æ‹©æ–‡ä»¶');
        return;
    }

    try {
        const fileId = await saveFileToDB(f);
        let p = {
            type: f.type.startsWith('image') ? 'img' : 'vid',
            fileId: fileId,
            exp: Date.now() + parseInt(h)
        };
        let a = JSON.parse(localStorage.private || '[]');
        a.unshift(p);
        localStorage.private = JSON.stringify(a);
        alert('å‘å¸ƒæˆåŠŸ');
        show();
    } catch (e) {
        alert('ä¸Šä¼ æ–‡ä»¶å¤±è´¥: ' + e.message);
    }
}

// ä¿å­˜æ–‡ä»¶åˆ° IndexedDB
function saveFileToDB(file) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['files'], 'readwrite');
        const store = transaction.objectStore('files');
        const request = store.add({ file: file });

        request.onsuccess = () => resolve(request.result);
        request.onerror = () => reject(request.error);
    });
}

// ä» IndexedDB è¯»å–æ–‡ä»¶
function getFileFromDB(id) {
    return new Promise((resolve, reject) => {
        const transaction = db.transaction(['files'], 'readonly');
        const store = transaction.objectStore('files');
        const request = store.get(id);

        request.onsuccess = () => {
            if (request.result) {
                const url = URL.createObjectURL(request.result.file);
                resolve(url);
            } else {
                reject('æ–‡ä»¶ä¸å­˜åœ¨');
            }
        };
        request.onerror = () => reject(request.error);
    });
}

// æ˜¾ç¤ºåŠ¨æ€åˆ—è¡¨
async function show() {
    let posts = JSON.parse(localStorage.posts || '[]');
    let h = '';

    for (const o of posts) {
        let mediaHtml = '';
        if (o.fileId) {
            try {
                const url = await getFileFromDB(o.fileId);
                mediaHtml = o.type === 'img'
                    ? `<img src="${url}" onclick="view(this)">`
                    : `<video src="${url}" controls></video>`;
            } catch (e) {
                mediaHtml = `<p>æ–‡ä»¶åŠ è½½å¤±è´¥: ${e}</p>`;
            }
        }
        h += `<div class="card">${o.txt || ''}${mediaHtml}<br><button class="btn del" onclick="del(${posts.indexOf(o)})">åˆ é™¤</button></div>`;
    }

    document.getElementById('list').innerHTML = h;
}

// åˆ é™¤åŠ¨æ€
function del(i) {
    let a = JSON.parse(localStorage.posts || '[]');
    a.splice(i, 1);
    localStorage.posts = JSON.stringify(a);
    show();
}

// æŸ¥çœ‹å¤§å›¾
function view(img) {
    document.getElementById('viewImg').src = img.src;
    document.getElementById('imgViewer').style.display = 'grid';
}

// å…³é—­æŸ¥çœ‹å™¨
function closeViewer() {
    document.getElementById('imgViewer').style.display = 'none';
}
</script>
</body>
</html>
